# Система управления обращениями

Система для управления заявками и обращениями, построенная с использованием Node.js, Express и PostgreSQL. Поддерживает русский язык с корректной обработкой кириллицы.

## Особенности системы

- Создание новых обращений с темой и описанием
- Управление статусами обращений (Новое → В работе → Завершено/Отменено)
- Добавление решения при завершении обращения
- Указание причины при отмене обращения
- Фильтрация списка обращений по дате
- Групповое действие: отмена всех обращений "В работе"
- Полная поддержка кириллицы (русский язык) на всех уровнях системы

## Статусы обращений

В системе предусмотрены следующие статусы:
- **Новое** - обращение создано, но еще не взято в работу
- **В работе** - обращение принято и находится в процессе обработки
- **Завершено** - обработка обращения завершена с указанием решения
- **Отменено** - обращение отменено с указанием причины

## Настройка базы данных

1. Убедитесь, что у вас установлен PostgreSQL
2. Запустите SQL-скрипт из файла `recreate_db.sql` для создания базы данных с правильной кодировкой UTF-8:

```bash
psql -U postgres -f recreate_db.sql
```

Скрипт выполнит следующие действия:
- Создаст базу данных `tickets_utf8` с кодировкой UTF-8
- Настроит правильные параметры локали для русского языка
- Создаст таблицу `appeals` с необходимыми полями
- Добавит тестовые данные для проверки работы системы

## Установка и запуск

1. Клонируйте репозиторий
2. Установите зависимости:
```bash
npm install
```
3. Создайте файл `.env` с настройками подключения к базе данных:
```
PORT=3000
DB_USER=username
DB_PASSWORD=password
DB_HOST=host
DB_PORT=port
DB_NAME=tickets_utf8
```
4. Запустите сервер:
```bash
npm start
```
5. Для разработки с автоматической перезагрузкой:
```bash
npm run dev
```

После запуска приложение будет доступно по адресу: http://localhost:3000

## API эндпоинты

### Создание обращения
- **URL:** `/api/tickets`
- **Метод:** `POST`
- **Тело запроса:** 
  ```json
  {
    "subject": "Тема обращения",
    "text": "Подробное описание проблемы"
  }
  ```

### Взятие обращения в работу
- **URL:** `/api/tickets/:id/take`
- **Метод:** `PUT`

### Завершение обращения
- **URL:** `/api/tickets/:id/complete`
- **Метод:** `PUT`
- **Тело запроса:** 
  ```json
  {
    "solution": "Описание решения проблемы"
  }
  ```

### Отмена обращения
- **URL:** `/api/tickets/:id/cancel`
- **Метод:** `PUT`
- **Тело запроса:** 
  ```json
  {
    "cancellation_reason": "Причина отмены"
  }
  ```

### Получение списка обращений с фильтрацией
- **URL:** `/api/tickets`
- **Метод:** `GET`
- **Параметры запроса:**
  - `date`: Фильтр по конкретной дате (YYYY-MM-DD)

### Отмена всех обращений "В работе"
- **URL:** `/api/tickets/cancel-all-in-progress`
- **Метод:** `PUT`
- **Тело запроса:** 
  ```json
  {
    "cancellation_reason": "Причина отмены"
  }
  ```

## Работа с кириллицей

В проекте реализованы специальные механизмы для корректной работы с русским языком:

1. **База данных**: 
   - Настроена кодировка `UTF8` при создании базы данных
   - Установлены параметры локали для русского языка

2. **Серверная часть**:
   - Настроено подключение к базе данных с параметром `client_encoding=UTF8`
   - Установлены заголовки для корректной передачи данных

3. **Клиентская часть**:
   - Добавлена функция `fixEncoding()` для исправления возможных проблем с кодировкой
   - Реализовано определение и нормализация текста статусов

## Структура проекта

```
project/
├── public/                 # Статические файлы клиентской части
│   ├── index.html          # Главная страница приложения
│   ├── styles.css          # CSS стили
│   └── app.js              # Клиентский JavaScript
├── src/                    # Исходный код серверной части
│   ├── controllers/        # Контроллеры для обработки запросов
│   ├── db/                 # Конфигурация базы данных
│   ├── routes/             # Маршруты API
│   └── index.js            # Основной файл приложения
├── recreate_db.sql         # SQL-скрипт для создания базы данных
├── .env                    # Файл с переменными окружения (не включен в репозиторий)
├── package.json            # Зависимости проекта
└── README.md               # Документация
```

## Устранение неполадок

### Проблемы с кодировкой кириллицы
Если вы видите некорректное отображение русского текста:

1. Убедитесь, что база данных создана с параметрами из `recreate_db.sql`
2. Проверьте настройки подключения в файле `src/db/db.js`
3. В браузере проверьте, что страница использует кодировку UTF-8

## Зависимости

- Express 
- pg 
- cors 
- dotenv
- nodemon (dev) 